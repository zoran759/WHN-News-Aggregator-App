{% extends "base.html" %}

{% load posts_extras %}

{% block viewport %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
{% endblock %}

{% block css %}
    <link href="{{ STATIC_URL }}css/index.css" rel="stylesheet">
    <link href="{{ STATIC_URL }}css/bootstrap-lightbox.css" rel="stylesheet">
    <link href="{{ STATIC_URL }}css/snap.css" rel="stylesheet">
{% endblock %}

{% block js %}
    {% include "partial/vote.html" %}
    <!--script src="http://code.jquery.com/jquery-latest.js"></script-->
    <script type="text/javascript" src="{{ STATIC_URL }}js/vote-popover.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/index.js"></script>
    <script src="{{ STATIC_URL }}el-pagination/js/el-pagination.js"></script>
    <!--script src="{{ STATIC_URL }}js/bootstrap-lightbox.js"></script-->
    <script>
        $.endlessPaginate({});
    </script>
    <script>
        var isSmallScreen = $(window).width() < 992;
        //isSmallScreen=!$("#view-both").is(":visible");
        if (!isSmallScreen) $.getScript("{{ STATIC_URL }}js/bootstrap-lightbox.js");

        {% comment %}
        $(window).resize(sizeContent);

        //Dynamically assign height
        function sizeContent() {
        if(isSmallScreen) return;
        var newHeight = $("html").height();// - $("#header").height() - $("#footer").height() + "px";
        $("#story-list").css("height", newHeight-$("#story-list").offset().top);//If footer were there, subtract 80 from each of these
        $("#image-list").css("height", newHeight-$("#image-list").offset().top);
        }

        $(function() {
        sizeContent();
        });

        //we have to watch for this ourselves because the default endlesspaginate scroll only
        //works for window scrolling, not indiviudal divs.
        function checkScroll() {
        var scrollTop = $(this).scrollTop();
        var innerHeight = $(this).innerHeight();

        //<
        if(scrollTop+innerHeight >= $("#"+$(this).attr("id")+" > .items").height()-10) {
        $("#"+$(this).attr("id")+" > .items > div.endless_container > a").click();
        }
        }
        $("#story-list").scroll(checkScroll);
        $("#image-list").scroll(checkScroll);

        function checkScrollMobile() {
        if($(window).scrollTop() + $(window).height() >= $(document).height()){
        $("div.endless_container > a:visible").click();
        }
        }
        $(window).scroll(checkScrollMobile);
        {% endcomment %}
    </script>
    <script src="{{ STATIC_URL }}js/images-filter.js"></script>

<!-- remove this-->
    <script src="{{ STATIC_URL }}js/snap.js"></script>
    <script>
    var snapper = new Snap({
    element: document.getElementById('main-content'),
    dragger: document.getElementById('drag-handle'),
    touchToDrag: isSmallScreen,
    tapToClose: true,
    });
    </script>
    <script>
      $("#drawer-btn").click(function() {
      console.log("click!");
      if(snapper.state().state == "left") {
      $(this).html('<span class="glyphicon glyphicon-chevron-right"></span> MENU');
      snapper.close();
      } else {
      $(this).html('<span class="glyphicon glyphicon-chevron-left"></span> MENU');
      snapper.open('left');
      }
      });
    </script>
<!-- -->

    <script>
    </script>
    <script>
        if (isSmallScreen) {
            $('[data-toggle="lightbox"]').removeAttr('data-toggle').removeAttr('href');
        }
    </script>

    {% if user.is_staff %}
        <script>
            function delete_img(img_id) {
                $.get("/staff_delete/img/" + img_id);
                $("#instagram-image-" + img_id).remove();
                $("#" + img_id + "lightbox").remove();
            }

            /*
            function setUpDeleteListeners() {
            $(".delete-image-link").click(function() {
            });
            }
            setUpDeleteListeners();*/
        </script>
    {% endif %}
{% endblock %}

{% block extra_header_layout %}
    <button class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored" id="submit-post-btn"
            data-toggle="modal"
            href="#submit-post-modal">
        <i class="material-icons">add</i>
    </button>
{% endblock %}


{% block header_tabs %}
    <div class="mdl-layout__header-row">
        <ul class="right-header nav navbar-nav navbar-right" style="margin-left:50%;">
            <li class="navbar-sort-tab view-just-stories">
                <div class="navbar-text">
                    Stories
                </div>
            </li>
            <li class="navbar-sort-tab view-just-images">
                <div class="navbar-text">
                    Pictures
                </div>
            </li>
            <li class="navbar-sort-tab view-both active">
                <div class="navbar-text">
                    Mix
                </div>
            </li>
        </ul>
    </div>
{% endblock %}


{% block pre-content %}
    <div class="modal" id="submit-post-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title text-center">motoranger</h4>
                </div>
                <div class="modal-body">

                    <div class="row">
                        <div class="col-md-10 col-md-offset-1">
                            {% include "partial/new_post_form.html" %}
                        </div>
                    </div>

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    {# {% include "partial/snap-drawers.html" %} #}
{% endblock %}

{% block content %}
    <div class="row story-row">
        {% for post in posts %}
            <div class="col-md-3" class="story">
                <div class="mdl-card mdl-shadow--2dp story-card">
                    <div class="mdl-card__title story-card-title-container">
                        <h2 class="mdl-card__title-text story-card-title-h2"><a href="{% url 'view_post' post.pk %}"
                                                                                class="story-card-title">{{post.title}}</a></h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <div class="col-md-8 story-card-info-block">
                            <a href="{% url 'view_profile' post.submitter.pk %}"
                               class="story-card-submitter">{{ post.submitter }}</a>
                            <br>
                            <span class="story-card-domain">{{ post.url|domainize }}</span>
                        </div>
                        <div class="col-md-4">

                        </div>
                    </div>
                    <div class="mdl-card__actions story-card-actions">
                        <a class="story-card-comment-link" href="{% url 'view_post' post.pk %}">Comment</a>
                        <button class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored vote-btn upvote-btn">
                            <i class="material-icons">arrow_drop_up</i>
                        </button>
                        Like
                        <button class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored vote-btn downvote-btn">
                            <i class="material-icons">arrow_drop_down</i>
                        </button>
                        Dislike
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% comment %}
{# the old style #}
<div class="row" style="margin-top:200px;">
  <div class="col-md-4" id="story-section">
    <div class="row" style="margin-left:15px;">
      <div class="col-md-12" style="margin-bottom:5px;">
        <a id="new-stories-filter" class="btn btn-primary stories-filter" filter_ref="new">NEW</a>
        <a id="popular-stories-filter" class="btn btn-default stories-filter" filter_ref="popular" style="display:none;">POPULAR</a>
        <a id="ask-stories-filter" class="btn btn-default stories-filter" filter_ref="ask" style="display:none;">ASK</a>
      </div>
    </div>
    <!--a id="new-posts">New</a-->
    <!--a id="ask-posts">Ask</a-->
    <div id="story-list" style="overflow-x:hidden;overflow-y:scroll;z-index:2;position:relative;min-height:400px;">
      <p style="margin-left:30px;"><a data-toggle="modal" href="{% if user.is_authenticated %}#submit-post-modal{% else %}#register-modal{% endif %}"
          class="btn btn-primary submit-button">SUBMIT a link to <span class="site-name">PLANTDIET<em>life</em></span></a></p>
      <ol class="items" start="{{ posts.start_index }}">
        {% include "partial/post_template.html" %}
      </ol>
    </div>
  </div>

  <div class="col-md-8" id="image-section" style="padding-left:30px;">
    <div class="row">
      <div class="col-md-12" style="margin-bottom:5px;">
        <a id="popular-images-filter" class="btn btn-primary images-filter" filter_ref="popular">POPULAR</a>
        <a id="new-images-filter" class="btn btn-default images-filter" filter_ref="new" style="display:none">LATEST</a>
        <a id="most-comments-images-filter" class="btn btn-default images-filter" filter_ref="most_comments" style="display:none">MOST
          COMMENTS</a>
        <a id="vegan-filter" class="btn btn-default images-filter" filter_ref="vegan" style="display:none">#VEGAN</a>
      </div>
    </div>
    <div id="image-list" style="overflow-y:scroll; overflow-x:hidden;min-height:400px;">
      <div class="items">
        {% include "partial/image_template.html" %}
      </div>
    </div>
  </div>
</div>
{% endcomment %}
{% endblock %}

{% block above-footer %}{% if posts.has_next %}
    <a onclick="_gaq.push(['_trackEvent', 'Navigation', 'More btn', 'The more button at the bottom of the indexes.']);"
       href="?page={{ posts.next_page_number }}" class="more-link">More</a>{% endif %}
{% endblock %}

{% block bottom-of-body %}
    {% for posts, images in posts_and_images %}
        {% for image in images %}
            {% include "partial/lightbox.html" %}
        {% endfor %}
    {% endfor %}
{% endblock %}